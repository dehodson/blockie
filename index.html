<!doctype html>
<html>
<head>
	<title>blockie</title>
	<style>
		body, html{
			height:cellSize%;
			margin:0;
		}
		#game-title{
			position: absolute;
			font-size:50px;
			top: -55px;
			left: 0px;
		}
		#level{
			position: absolute;
			font-size:50px;
			top: -55px;
			right: 0px;
		}
		#restart{
			position: absolute;
			font-size:50px;
			bottom: -55px;
			right: 0px;
		}
		#main{
			height:500px;
			width:500px;
			background-color: #FCC;
			position: absolute;
			top:0px;
			left:0px;
			right:0px;
			bottom:0px;
			margin:auto;
			border-radius: 3px;
		}
		.cell{
			height:98px;
			width: 98px;
			margin:1px;
			position: absolute;
			background-color: red;
			transition: top .1s, left .1s;
			z-index: 1;
			border-radius: 10px;
		}
		.block{
			height:94px;
			width: 94px;
			padding:3px;
			position: absolute;
			background-color: black;
		}
		.victory{
			height:100px;
			width: 100px;
			position: absolute;
			background-color: yellow;
		}
	</style>
</head>
	<body onkeydown="keyPressed(event);">
		<div id="main">
			<div id="game-title">blockie</div>
			<div id="level">level:&nbsp;<span id="current-level">1</span></div>
			<div id="restart" onclick="startLevel(levels[currentLevel])">restart</div>
		</div>
	</body>
	<script type="text/javascript">
		var levels   = [
			[[4,4,1],[3,4,1],[4,3,1],[2,2,2],[2,3,2],[2,0,2],[0,0,3],[1,0,3],[4,1,3]]
		];
		var grid     = [];
		var canPress = true;
		var victory  = [];
		var currentLevel = 0;
		var gameMode = 0;
		var gridSizeX = 5;
		var gridSizeY = 5;
		var cellSize  = 100;

		for(var i = 0; i < gridSizeY; i++){
			grid.push(new Array(gridSizeX).fill(0));
		}

		function clearType(type){
			var list = document.getElementsByClassName(type);

			while(list.length > 0){
				list[0].parentNode.removeChild(list[0]);
			}
		}

		function startLevel(level){
			var main = document.getElementById("main");
			victory  = [];

			grid = [];
			for(var i = 0; i < gridSizeY; i++){
				grid.push(new Array(gridSizeX).fill(0));
			}

			clearType("block");
			clearType("cell");
			clearType("victory");

			document.getElementById("current-level").innerText = currentLevel + 1;

			for(var i = 0; i < level.length; i++){
				if(level[i][2] == 1){
					var x = level[i][1];
					var y = level[i][0];
					var cell = document.createElement("div");
					grid[y][x] = 1;
					cell.className  = "cell";
					cell.id 		= y+"-"+x
					cell.style.top  = (cellSize * y) + "px";
					cell.style.left = (cellSize * x) + "px";
					main.appendChild(cell);
				}else if(level[i][2] == 2){
					var x = level[i][1];
					var y = level[i][0];
					var cell = document.createElement("div");
					grid[y][x] = 2;
					cell.className  = "block";
					cell.id 		= y+"-"+x
					cell.style.top  = (cellSize * y) + "px";
					cell.style.left = (cellSize * x) + "px";
					main.appendChild(cell);
				}else if(level[i][2] == 3){
					var x = level[i][1];
					var y = level[i][0];
					var cell = document.createElement("div");
					cell.className  = "victory";
					cell.id 		= y+"-"+x+"-victory";
					victory.push(y+"-"+x);
					cell.style.top  = (cellSize * y) + "px";
					cell.style.left = (cellSize * x) + "px";
					main.appendChild(cell);
				}
			}
		}

		function winLevel(){
			alert("You win!");
		}

		function moveBricks(direction){
			function doVerticalMove(){
				if(last != i){
					var element = document.getElementById(i+"-"+j);
					element.style.top = (cellSize * last) + "px";
					element.id = last+"-"+j;
					grid[last][j] = 1;
					grid[i][j]    = 0;
				}
			}
			function doHorizontalMove(){
				if(last != j){
					var element = document.getElementById(i+"-"+j);
					element.style.left = (cellSize * last) + "px";
					element.id = i+"-"+last;
					grid[i][last] = 1;
					grid[i][j]    = 0;
				}
			}

			if(direction == 'down'){
				for(var i = gridSizeY - 2; i >= 0; i--){
					for(var j = gridSizeX - 1; j >= 0; j--){
						if(grid[i][j] == 1){
							var last = gridSizeY - 1;
							for(var k = i + 1; k <= gridSizeY - 1; k++){
								if(grid[k][j] != 0){
									last = k - 1;
									break;
								}
							}

							doVerticalMove();
						}
					}
				}
			}else if(direction == 'up'){
				for(var i = 1; i <= gridSizeY - 1; i++){
					for(var j = gridSizeX - 1; j >= 0; j--){
						if(grid[i][j] == 1){
							var last = 0;
							for(var k = i - 1; k >= 0; k--){
								if(grid[k][j] != 0){
									last = k + 1;
									break;
								}
							}

							doVerticalMove();
						}
					}
				}
			}else if(direction == 'left'){
				for(var i = gridSizeY - 1; i >= 0; i--){
					for(var j = 1; j <= gridSizeX - 1; j++){
						if(grid[i][j] == 1){
							var last = 0;
							for(var k = j - 1; k >= 0; k--){
								if(grid[i][k] != 0){
									last = k + 1;
									break;
								}
							}

							doHorizontalMove();
						}
					}
				}
			}else if(direction == 'right'){
				for(var i = gridSizeY - 1; i >= 0; i--){
					for(var j = gridSizeX - 2; j >= 0; j--){
						if(grid[i][j] == 1){
							var last = gridSizeX - 1;
							for(var k = j + 1; k <= gridSizeX - 1; k++){
								if(grid[i][k] != 0){
									last = k - 1;
									break;
								}
							}

							doHorizontalMove();
						}
					}
				}
			}

			var victoryNum = 0;
			var boxes = document.getElementsByClassName("cell");
			for(var i = 0; i < victory.length; i++){
				for(var j = 0; j < boxes.length; j++){
					console.log(victory[i]);
					if(boxes[j].id == victory[i]){
						console.log(boxes[j].id + "+" + victory[i]);
						victoryNum++;
					}
				}
			}

			if(victoryNum == victory.length){
				setTimeout(winLevel, cellSize);
			}
		}

		function keyPressed(event){
			if(canPress){
				if(event.which == 38){        //up
					moveBricks('up');

				}else if(event.which == 37){  //left
					moveBricks('left');

				}else if(event.which == 39){  //right
					moveBricks('right');

				}else if(event.which == 40){  //down
					moveBricks('down');

				}else if(event.which == 82){  //R
					startLevel(levels[currentLevel]);

				}else if(event.which == 13){  //enter
					startLevel(levels[currentLevel]);

				}

				canPress = false;
				setTimeout(function(){canPress = true}, cellSize);
			}
		}

		startLevel(levels[currentLevel]);
	</script>
</html>